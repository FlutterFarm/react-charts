<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Web site created using create-react-app"
    />
    <link rel="apple-touch-icon" href="%PUBLIC_URL%/logo192.png" />
    <!--
      manifest.json provides metadata used when your web app is installed on a
      user's mobile device or desktop. See https://developers.google.com/web/fundamentals/web-app-manifest/
    -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"/>    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">        
    <link href="https://fonts.googleapis.com/css?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Two+Tone|Material+Icons+Round|Material+Icons+Sharp" rel="stylesheet">
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>React App</title>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="root"></div>
    <!--
      This HTML file is a template.
      If you open it directly in the browser, you will see an empty page.

      You can add webfonts, meta tags, or analytics to this file.
      The build step will place the bundled scripts into the <body> tag.

      To begin the development, run `npm start` or `yarn start`.
      To create a production bundle, use `npm run build` or `yarn build`.
    -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/e9a985ba15.js" crossorigin="anonymous"></script>                
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>  
    <script src="./assets/js/jquery.flowchart.js"></script>
    <script>
    $(document).ready(function() {
      var $flowchart = $('#flowchartworkspace');
      var $container = $flowchart.parent();
  
  
      // Apply the plugin on a standard, empty div...
      $flowchart.flowchart({
        data: defaultFlowchartData,
        defaultSelectedLinkColor: '#000055',
        grid: 10,
        multipleLinksOnInput: true,
        multipleLinksOnOutput: true
      });
  
  
      function getOperatorData($element) {
        var nbInputs = parseInt($element.data('nb-inputs'), 10);
        var nbOutputs = parseInt($element.data('nb-outputs'), 10);
        var data = {
          properties: {
            title: $element.text(),
            inputs: {},
            outputs: {}
          }
        };
  
        var i = 0;
        for (i = 0; i < nbInputs; i++) {
          data.properties.inputs['input_' + i] = {
            label: 'Input ' + (i + 1)
          };
        }
        for (i = 0; i < nbOutputs; i++) {
          data.properties.outputs['output_' + i] = {
            label: 'Output ' + (i + 1)
          };
        }
  
        return data;
      }
  
  
  
      //-----------------------------------------
      //--- operator and link properties
      //--- start
      var $operatorProperties = $('#operator_properties');
      $operatorProperties.hide();
      var $linkProperties = $('#link_properties');
      $linkProperties.hide();
      var $operatorTitle = $('#operator_title');
      var $linkColor = $('#link_color');
      var $operatorBackgroundColor = $('#operator_background_color');
      var $operatorFontColor = $('#operator_font_color');
      var $linkWidth = $('#link_width');
  
      $flowchart.flowchart({
        onOperatorSelect: function(operatorId) {
          $operatorProperties.show();
          $operatorTitle.val($flowchart.flowchart('getOperatorTitle', operatorId));
          $operatorBackgroundColor.val($flowchart.flowchart('getOperatorBackgroundColor', operatorId))
          return true;
        },
        onOperatorUnselect: function() {
          $operatorProperties.hide();
          return true;
        },
        onLinkSelect: function(linkId) {
          $linkProperties.show();
          $linkColor.val($flowchart.flowchart('getLinkMainColor', linkId));
          return true;
        },
        onLinkUnselect: function() {
          $linkProperties.hide();
          return true;
        }
      });
  
      $operatorTitle.keyup(function() {
        var selectedOperatorId = $flowchart.flowchart('getSelectedOperatorId');
        if (selectedOperatorId != null) {
          $flowchart.flowchart('setOperatorTitle', selectedOperatorId, $operatorTitle.val());
        }
      });
  
      $linkColor.change(function() {
        var selectedLinkId = $flowchart.flowchart('getSelectedLinkId');
        if (selectedLinkId != null) {
          $flowchart.flowchart('setLinkMainColor', selectedLinkId, $linkColor.val());
        }
      });
      
      $linkWidth.change(function() {
        var selectedLinkId = $flowchart.flowchart('getSelectedLinkId');
        console.log(selectedLinkId);
        if (selectedLinkId != null) {
          $flowchart.flowchart('setLinkWidth', selectedLinkId, $linkWidth.val());
        }
      });      

      $operatorBackgroundColor.change(function() {
        var selectedOperatorBackground = $flowchart.flowchart('getSelectedOperatorId');
        if (selectedOperatorBackground != null) {
          $flowchart.flowchart('setOperatorBackground', selectedOperatorBackground, $operatorBackgroundColor.val());
        }
      });      
      //--- end
      //--- operator and link properties
      //-----------------------------------------
  
      //-----------------------------------------
      //--- delete operator / link button
      //--- start
      $flowchart.parent().siblings('.delete_selected_button').click(function() {
        $flowchart.flowchart('deleteSelected');
      });
      //--- end
      //--- delete operator / link button
      //-----------------------------------------
  
  
  
      //-----------------------------------------
      //--- create operator button
      //--- start
      var operatorI = 0;
      $flowchart.parent().siblings('.create_operator').click(function() {
        var operatorId = 'created_operator_' + operatorI;
        var operatorData = {
          top: ($flowchart.height() / 2) - 30,
          left: ($flowchart.width() / 2) - 100 + (operatorI * 10),
          properties: {
            title: 'Operator ' + (operatorI + 3),
            backgrondColor : "#076afe",
            fontColor : "black",            
            inputs: {
              input_1: {
                label: 'Reference site about Lorem Ipsum.',
              },
              input_2: {
                label: 'Reference site about Lorem Ipsum.',
              },
              input_3: {
                label: 'Reference site about Lorem Ipsum.',
              },
              input_4: {
                label: 'Reference site about Lorem Ipsum.',
              },                            
            },
            outputs: {
              output_1: {
                label: 'Reference site about Lorem Ipsum.',
              },
              output_2: {
                label: 'Reference site about Lorem Ipsum.',
              },              
              output_3: {
                label: 'Reference site about Lorem Ipsum.',
              },
              output_4: {
                label: 'Reference site about Lorem Ipsum.',
              },                            
            }
          }
        };
  
        operatorI++;
  
        $flowchart.flowchart('createOperator', operatorId, operatorData);
  
      });
      //--- end
      //--- create operator button
      //-----------------------------------------
  
  
  
  
      //-----------------------------------------
      //--- draggable operators
      //--- start
      //var operatorId = 0;
      var $draggableOperators = $('.draggable_operator');
      $draggableOperators.draggable({
        cursor: "move",
        opacity: 0.7,
  
        // helper: 'clone',
        appendTo: 'body',
        zIndex: 1000,
  
        helper: function(e) {
          var $this = $(this);
          var data = getOperatorData($this);
          return $flowchart.flowchart('getOperatorElement', data);
        },
        stop: function(e, ui) {
          var $this = $(this);
          var elOffset = ui.offset;
          var containerOffset = $container.offset();
          if (elOffset.left > containerOffset.left &&
            elOffset.top > containerOffset.top &&
            elOffset.left < containerOffset.left + $container.width() &&
            elOffset.top < containerOffset.top + $container.height()) {
  
            var flowchartOffset = $flowchart.offset();
  
            var relativeLeft = elOffset.left - flowchartOffset.left;
            var relativeTop = elOffset.top - flowchartOffset.top;
  
            var positionRatio = $flowchart.flowchart('getPositionRatio');
            relativeLeft /= positionRatio;
            relativeTop /= positionRatio;
  
            var data = getOperatorData($this);
            data.left = relativeLeft;
            data.top = relativeTop;
  
            $flowchart.flowchart('addOperator', data);
          }
        }
      });
      //--- end
      //--- draggable operators
      //-----------------------------------------
  
  
      //-----------------------------------------
      //--- save and load
      //--- start
      function Flow2Text() {
        var data = $flowchart.flowchart('getData');
        $('#flowchart_data').val(JSON.stringify(data, null, 2));
      }
      $('#get_data').click(Flow2Text);
  
      function Text2Flow() {
        var data = JSON.parse($('#flowchart_data').val());
        $flowchart.flowchart('setData', data);
      }
      $('#set_data').click(Text2Flow);
  
      /*global localStorage*/
      function SaveToLocalStorage() {
        if (typeof localStorage !== 'object') {
          alert('local storage not available');
          return;
        }
        Flow2Text();
        localStorage.setItem("stgLocalFlowChart", $('#flowchart_data').val());
      }
      $('#save_local').click(SaveToLocalStorage);
  
      function LoadFromLocalStorage() {
        if (typeof localStorage !== 'object') {
          alert('local storage not available');
          return;
        }
        var s = localStorage.getItem("stgLocalFlowChart");
        if (s != null) {
          $('#flowchart_data').val(s);
          Text2Flow();
        }
        else {
          alert('local storage empty');
        }
      }
      $('#load_local').click(LoadFromLocalStorage);
      //--- end
      //--- save and load
      //-----------------------------------------
  
  
    });
  
    var defaultFlowchartData = {
      operators: {
        operator1: {
          top: 20,
          left: 20,
          properties: {
            title: 'Operator 1',
            backgrondColor : "#e91b1b",
            fontColor : "black",
            inputs: {},
            outputs: {
              output_1: {
                label: 'Output 1',
              }
            }
          }
        },
        operator2: {
          top: 80,
          left: 300,
          properties: {
            title: 'Operator 2',
            backgrondColor : "#e91b1b",
            fontColor : "black",            
            inputs: {
              input_1: {
                label: 'Reference site about Lorem Ipsum.',
              },
              input_2: {
                label: 'Reference site about Lorem Ipsum.',
              },
            },
            outputs: {
              output_1: {
                label: 'Reference site about Lorem Ipsum.',
              },
              output_2: {
                label: 'Reference site about Lorem Ipsum.',
              },              
            }
          }
        },
      },
      links: {
        link_1: {
          fromOperator: 'operator1',
          fromConnector: 'output_1',
          toOperator: 'operator2',
          toConnector: 'input_2',
          toLinkWidth : "10",
        },
      }
    };
    if (false){
      console.log('remove lint unused warning', defaultFlowchartData);  
    } 
    </script>    
  </body>
</html>
